<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Docs, code and samples for my own Tanzu gym"><link href=https://matteo-magni.github.io/tanzugym/tkgm/identity-management/ rel=canonical><link href=../ingress/ rel=prev><link href=../troubleshooting/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.3, mkdocs-material-9.1.18"><title>Identity management - The Tanzu Gym</title><link rel=stylesheet href=../../assets/stylesheets/main.26e3688c.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ecc896b0.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Metropolis,Avenir+Next,Helvetica+Neue,Arial,sans-serif:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Metropolis,Avenir Next,Helvetica Neue,Arial,sans-serif";--md-code-font:"JetBrains Mono"}</style><link rel=stylesheet href=../../assets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=light-blue data-md-color-accent=lime> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#identity-management class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="The Tanzu Gym" class="md-header__button md-logo" aria-label="The Tanzu Gym" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13.95 13.5h-.23c-.18.11-.26.32-.18.5l.86 2.11c.83-.53 1.46-1.32 1.79-2.25l-2.23-.36h-.01m-3.45.29a.415.415 0 0 0-.38-.29h-.08l-2.22.37c.33.92.96 1.7 1.79 2.23l.85-2.07V14c.04-.05.04-.14.04-.21m1.83.81a.378.378 0 0 0-.51-.15c-.07.05-.12.08-.15.15h-.01l-1.09 1.97c.78.26 1.62.31 2.43.12.14-.03.29-.07.43-.12l-1.09-1.97h-.01m3.45-4.57L14.1 11.5l.01.03a.37.37 0 0 0-.04.53c.05.06.11.1.18.12l.01.01 2.17.62c.07-.97-.14-1.95-.65-2.78m-3.11.16c.01.21.18.37.39.36.08 0 .15-.02.21-.05h.01l1.83-1.31a4.45 4.45 0 0 0-2.57-1.24l.13 2.24m-1.94.31c.17.11.4.08.52-.09.05-.06.07-.13.08-.21h.01l.12-2.25c-.15.02-.3.05-.46.08-.8.18-1.54.58-2.12 1.16l1.84 1.31h.01m-.99 1.69c.2-.05.32-.26.26-.46 0-.08-.05-.14-.11-.19v-.01L8.21 10c-.52.86-.74 1.84-.63 2.82l2.16-.62v-.01m1.64.66.62.3.62-.3.15-.67-.43-.53h-.69l-.43.53.16.67m10.89 1.32L20.5 6.5c-.09-.42-.37-.76-.74-.94l-7.17-3.43c-.37-.17-.81-.17-1.19 0L4.24 5.56c-.37.18-.65.52-.74.94l-1.77 7.67c-.05.2-.05.4 0 .59.01.06.03.12.05.18.03.09.08.19.13.27.03.04.05.08.09.11l4.95 6.18c.02 0 .05.04.05.06.1.09.19.16.28.22.12.08.26.14.4.17.11.05.23.05.32.05h8.12c.07 0 .14-.03.2-.05.05-.01.1-.03.14-.04.04-.02.07-.03.11-.05.05-.02.1-.05.15-.08.12-.08.23-.18.33-.28l.15-.2 4.8-5.98c.1-.12.17-.25.22-.38.02-.06.04-.12.05-.18.05-.19.05-.4 0-.59m-7.43 2.99c.02.06.04.12.07.17-.04.08-.06.17-.03.26.12.24.23.46.38.68.08.11.16.23.24.34 0 .03.03.08.04.12.12.2.06.46-.15.59s-.47.05-.59-.15c-.01-.03-.02-.05-.03-.08-.02-.03-.04-.09-.06-.09-.05-.15-.09-.28-.12-.41-.09-.25-.17-.49-.3-.72a.375.375 0 0 0-.21-.14l-.08-.16c-1.29.48-2.7.48-3.97-.01l-.1.18c-.07.01-.14.04-.19.09-.14.24-.24.49-.33.77-.03.13-.07.26-.12.4-.02 0-.04.07-.06.1a.43.43 0 0 1-.81-.29c.01-.03.03-.05.04-.08.04-.03.04-.08.04-.11.09-.12.16-.23.24-.35.16-.21.29-.45.39-.69a.54.54 0 0 0-.03-.25l.07-.18a5.611 5.611 0 0 1-2.47-3.09l-.2.03a.388.388 0 0 0-.23-.09c-.27.05-.51.13-.77.22-.11.06-.24.11-.37.15-.03.01-.07.02-.13.03a.438.438 0 0 1-.54-.27c-.07-.23.04-.47.28-.55.02 0 .05-.01.08-.01v-.01h.01l.11-.02c.14-.04.28-.04.41-.04.26 0 .52-.06.77-.12.08-.05.14-.11.19-.19l.19-.05c-.21-1.36.1-2.73.86-3.87l-.14-.12c0-.09-.03-.18-.08-.25-.2-.17-.41-.32-.64-.45-.12-.06-.24-.13-.36-.21-.02-.02-.06-.05-.08-.07l-.01-.01c-.2-.16-.25-.42-.11-.63.09-.1.21-.15.35-.15.11.01.21.05.3.12l.09.07c.1.09.19.2.28.3.18.19.37.37.58.52.08.04.17.05.26.03l.15.11c.75-.8 1.73-1.36 2.8-1.6.25-.06.52-.1.78-.12l.01-.18a.45.45 0 0 0 .14-.23c.01-.26-.01-.52-.05-.77-.03-.13-.05-.27-.06-.41V5.1c-.02-.24.15-.45.39-.48s.44.15.47.38v.22c-.01.14-.03.28-.06.41-.04.25-.06.51-.05.77.02.1.07.17.14.22l.01.19c1.36.12 2.62.73 3.56 1.72l.16-.12c.09.02.18.01.26-.03.21-.15.41-.33.58-.52.09-.1.18-.2.28-.3.03-.02.07-.06.1-.06.17-.18.44-.18.59 0 .19.16.18.43 0 .6 0 .02-.03.04-.06.06a2.495 2.495 0 0 1-.44.28c-.23.13-.45.28-.64.45-.06.07-.09.15-.08.24l-.16.14a5.44 5.44 0 0 1 .88 3.86l.19.05c.04.08.11.14.19.18.25.07.51.11.77.14h.41c.03.03.08.04.12.05.24.03.4.25.37.49-.05.23-.24.4-.48.37-.03-.01-.07-.01-.07-.02v-.01c-.06 0-.1-.01-.14-.02-.13-.04-.25-.09-.36-.15-.26-.1-.5-.17-.77-.21-.09 0-.17 0-.23.08-.07-.01-.13-.02-.19-.03-.41 1.31-1.31 2.41-2.47 3.11Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> The Tanzu Gym </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Identity management </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=light-blue data-md-color-accent=lime aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=teal data-md-color-accent=lime aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/matteo-magni/tanzugym title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> matteo-magni/tanzugym </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> HOME </a> </li> <li class=md-tabs__item> <a href=../ class="md-tabs__link md-tabs__link--active"> Tanzu Kubernetes Grid </a> </li> <li class=md-tabs__item> <a href=../../tap/relocate-tap-images/ class=md-tabs__link> Tanzu Application Platform </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="The Tanzu Gym" class="md-nav__button md-logo" aria-label="The Tanzu Gym" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13.95 13.5h-.23c-.18.11-.26.32-.18.5l.86 2.11c.83-.53 1.46-1.32 1.79-2.25l-2.23-.36h-.01m-3.45.29a.415.415 0 0 0-.38-.29h-.08l-2.22.37c.33.92.96 1.7 1.79 2.23l.85-2.07V14c.04-.05.04-.14.04-.21m1.83.81a.378.378 0 0 0-.51-.15c-.07.05-.12.08-.15.15h-.01l-1.09 1.97c.78.26 1.62.31 2.43.12.14-.03.29-.07.43-.12l-1.09-1.97h-.01m3.45-4.57L14.1 11.5l.01.03a.37.37 0 0 0-.04.53c.05.06.11.1.18.12l.01.01 2.17.62c.07-.97-.14-1.95-.65-2.78m-3.11.16c.01.21.18.37.39.36.08 0 .15-.02.21-.05h.01l1.83-1.31a4.45 4.45 0 0 0-2.57-1.24l.13 2.24m-1.94.31c.17.11.4.08.52-.09.05-.06.07-.13.08-.21h.01l.12-2.25c-.15.02-.3.05-.46.08-.8.18-1.54.58-2.12 1.16l1.84 1.31h.01m-.99 1.69c.2-.05.32-.26.26-.46 0-.08-.05-.14-.11-.19v-.01L8.21 10c-.52.86-.74 1.84-.63 2.82l2.16-.62v-.01m1.64.66.62.3.62-.3.15-.67-.43-.53h-.69l-.43.53.16.67m10.89 1.32L20.5 6.5c-.09-.42-.37-.76-.74-.94l-7.17-3.43c-.37-.17-.81-.17-1.19 0L4.24 5.56c-.37.18-.65.52-.74.94l-1.77 7.67c-.05.2-.05.4 0 .59.01.06.03.12.05.18.03.09.08.19.13.27.03.04.05.08.09.11l4.95 6.18c.02 0 .05.04.05.06.1.09.19.16.28.22.12.08.26.14.4.17.11.05.23.05.32.05h8.12c.07 0 .14-.03.2-.05.05-.01.1-.03.14-.04.04-.02.07-.03.11-.05.05-.02.1-.05.15-.08.12-.08.23-.18.33-.28l.15-.2 4.8-5.98c.1-.12.17-.25.22-.38.02-.06.04-.12.05-.18.05-.19.05-.4 0-.59m-7.43 2.99c.02.06.04.12.07.17-.04.08-.06.17-.03.26.12.24.23.46.38.68.08.11.16.23.24.34 0 .03.03.08.04.12.12.2.06.46-.15.59s-.47.05-.59-.15c-.01-.03-.02-.05-.03-.08-.02-.03-.04-.09-.06-.09-.05-.15-.09-.28-.12-.41-.09-.25-.17-.49-.3-.72a.375.375 0 0 0-.21-.14l-.08-.16c-1.29.48-2.7.48-3.97-.01l-.1.18c-.07.01-.14.04-.19.09-.14.24-.24.49-.33.77-.03.13-.07.26-.12.4-.02 0-.04.07-.06.1a.43.43 0 0 1-.81-.29c.01-.03.03-.05.04-.08.04-.03.04-.08.04-.11.09-.12.16-.23.24-.35.16-.21.29-.45.39-.69a.54.54 0 0 0-.03-.25l.07-.18a5.611 5.611 0 0 1-2.47-3.09l-.2.03a.388.388 0 0 0-.23-.09c-.27.05-.51.13-.77.22-.11.06-.24.11-.37.15-.03.01-.07.02-.13.03a.438.438 0 0 1-.54-.27c-.07-.23.04-.47.28-.55.02 0 .05-.01.08-.01v-.01h.01l.11-.02c.14-.04.28-.04.41-.04.26 0 .52-.06.77-.12.08-.05.14-.11.19-.19l.19-.05c-.21-1.36.1-2.73.86-3.87l-.14-.12c0-.09-.03-.18-.08-.25-.2-.17-.41-.32-.64-.45-.12-.06-.24-.13-.36-.21-.02-.02-.06-.05-.08-.07l-.01-.01c-.2-.16-.25-.42-.11-.63.09-.1.21-.15.35-.15.11.01.21.05.3.12l.09.07c.1.09.19.2.28.3.18.19.37.37.58.52.08.04.17.05.26.03l.15.11c.75-.8 1.73-1.36 2.8-1.6.25-.06.52-.1.78-.12l.01-.18a.45.45 0 0 0 .14-.23c.01-.26-.01-.52-.05-.77-.03-.13-.05-.27-.06-.41V5.1c-.02-.24.15-.45.39-.48s.44.15.47.38v.22c-.01.14-.03.28-.06.41-.04.25-.06.51-.05.77.02.1.07.17.14.22l.01.19c1.36.12 2.62.73 3.56 1.72l.16-.12c.09.02.18.01.26-.03.21-.15.41-.33.58-.52.09-.1.18-.2.28-.3.03-.02.07-.06.1-.06.17-.18.44-.18.59 0 .19.16.18.43 0 .6 0 .02-.03.04-.06.06a2.495 2.495 0 0 1-.44.28c-.23.13-.45.28-.64.45-.06.07-.09.15-.08.24l-.16.14a5.44 5.44 0 0 1 .88 3.86l.19.05c.04.08.11.14.19.18.25.07.51.11.77.14h.41c.03.03.08.04.12.05.24.03.4.25.37.49-.05.23-.24.4-.48.37-.03-.01-.07-.01-.07-.02v-.01c-.06 0-.1-.01-.14-.02-.13-.04-.25-.09-.36-.15-.26-.1-.5-.17-.77-.21-.09 0-.17 0-.23.08-.07-.01-.13-.02-.19-.03-.41 1.31-1.31 2.41-2.47 3.11Z"/></svg> </a> The Tanzu Gym </label> <div class=md-nav__source> <a href=https://github.com/matteo-magni/tanzugym title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> matteo-magni/tanzugym </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> HOME </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> Tanzu Kubernetes Grid <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Tanzu Kubernetes Grid </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> Preface </a> </li> <li class=md-nav__item> <a href=../bastion/ class=md-nav__link> Prepare bastion host </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> Internal registry <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> Internal registry </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../registry/ class=md-nav__link> Deployment and configuration </a> </li> <li class=md-nav__item> <a href=../relocate-images/ class=md-nav__link> Relocate TKG images </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../management-cluster/ class=md-nav__link> TKG management cluster </a> </li> <li class=md-nav__item> <a href=../workload-cluster/ class=md-nav__link> TKG workload cluster </a> </li> <li class=md-nav__item> <a href=../ingress/ class=md-nav__link> Ingress controller </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Identity management <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Identity management </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#configure-okta-idp class=md-nav__link> Configure Okta IdP </a> <nav class=md-nav aria-label="Configure Okta IdP"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-a-new-application class=md-nav__link> Create a new application </a> </li> <li class=md-nav__item> <a href=#create-users-and-groups class=md-nav__link> Create users and groups </a> </li> <li class=md-nav__item> <a href=#configure-authorization-server class=md-nav__link> Configure authorization server </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-pinniped-during-management-cluster-deployment class=md-nav__link> Configure pinniped during management cluster deployment </a> </li> <li class=md-nav__item> <a href=#configure-pinniped-after-management-cluster-deployment class=md-nav__link> Configure pinniped after management cluster deployment </a> </li> <li class=md-nav__item> <a href=#provide-own-tls-certificates class=md-nav__link> Provide own TLS certificates </a> </li> <li class=md-nav__item> <a href=#configure-okta-redirect-uri class=md-nav__link> Configure Okta redirect URI </a> </li> <li class=md-nav__item> <a href=#get-the-kubeconfig-file class=md-nav__link> Get the kubeconfig file </a> </li> <li class=md-nav__item> <a href=#configure-rbac class=md-nav__link> Configure RBAC </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../troubleshooting/ class=md-nav__link> Troubleshooting </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> Tanzu Application Platform <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Tanzu Application Platform </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../tap/relocate-tap-images/ class=md-nav__link> Relocate TAP images </a> </li> <li class=md-nav__item> <a href=../../tap/add-tap-repository/ class=md-nav__link> Add TAP kapp repository </a> </li> <li class=md-nav__item> <a href=../../tap/relocate-tbs-dependencies/ class=md-nav__link> Relocate TBS dependencies </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#configure-okta-idp class=md-nav__link> Configure Okta IdP </a> <nav class=md-nav aria-label="Configure Okta IdP"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-a-new-application class=md-nav__link> Create a new application </a> </li> <li class=md-nav__item> <a href=#create-users-and-groups class=md-nav__link> Create users and groups </a> </li> <li class=md-nav__item> <a href=#configure-authorization-server class=md-nav__link> Configure authorization server </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#configure-pinniped-during-management-cluster-deployment class=md-nav__link> Configure pinniped during management cluster deployment </a> </li> <li class=md-nav__item> <a href=#configure-pinniped-after-management-cluster-deployment class=md-nav__link> Configure pinniped after management cluster deployment </a> </li> <li class=md-nav__item> <a href=#provide-own-tls-certificates class=md-nav__link> Provide own TLS certificates </a> </li> <li class=md-nav__item> <a href=#configure-okta-redirect-uri class=md-nav__link> Configure Okta redirect URI </a> </li> <li class=md-nav__item> <a href=#get-the-kubeconfig-file class=md-nav__link> Get the kubeconfig file </a> </li> <li class=md-nav__item> <a href=#configure-rbac class=md-nav__link> Configure RBAC </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=identity-management>Identity management<a class=headerlink href=#identity-management title="Permanent link">&para;</a></h1> <div class="admonition info"> <p class=admonition-title>Info</p> <p>The official VMware documentation is available at <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.1/tkg-deploy-mc-21/mgmt-iam-index.html>https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.1/tkg-deploy-mc-21/mgmt-iam-index.html</a>.</p> </div> <p>This guide focuses on OIDC authentication and, as such, leverages <a href=https://developer.okta.com/ >Okta developer platform</a> as an OIDC-compliant <abbr title="Identity Provider">IdP</abbr>.</p> <p>For the moment, it takes a <em>ClickOps</em> approach for testing things quickly, but in the future it is planned to switch to a more scripted and IaC-oriented methodology. An <a href=https://registry.terraform.io/providers/okta/okta/latest/docs>Okta Terraform provider</a> is available, indeed, so the plan is to eventually configure everything with it, following <a href=https://developer.okta.com/blog/2021/11/08/k8s-api-server-oidc>this blog post</a>.</p> <p>Pinniped is the component used for authenticating against LDAP or OIDC endpoints, and comes as a package in TKG. It is silently installed at deploy time, but can be configured either during management cluster deployment or afterwards.</p> <h2 id=configure-okta-idp>Configure Okta <abbr title="Identity Provider">IdP</abbr><a class=headerlink href=#configure-okta-idp title="Permanent link">&para;</a></h2> <p>You can sign up to an <a href=https://developer.okta.com/ >Okta developer account</a> to get started quickly with an OIDC-compliant identity provider, and run some authentication and authorisation tests from your TKG platform.</p> <p>The simplest use case is to have users authenticate against Okta, retrieve the groups they belong to and assign Kubernetes permissions based on groups. RBAC is still configured on the Kubernetes end, whilst the authentication part is completely delegated to the <abbr title="Identity Provider">IdP</abbr>.</p> <h3 id=create-a-new-application>Create a new application<a class=headerlink href=#create-a-new-application title="Permanent link">&para;</a></h3> <p>Log into your Okta developer account and go to <code>Applications</code> -&gt; <code>Applications</code> -&gt; <code>Create a new app integration</code>, select <code>OIDC - OpenID Connect</code> as sign-in method and <code>Web Application</code> as application type.</p> <p>Pick a name for the app (i.e. <code>tkgm</code>), enable the refresh token amd save; you will have to <a href=#configure-okta-redirect-uri>set the sign-in redirect URI</a> when pinniped is up and running. Save the Client ID and the Client Secret, you will need them for configuring pinniped.</p> <h3 id=create-users-and-groups>Create users and groups<a class=headerlink href=#create-users-and-groups title="Permanent link">&para;</a></h3> <p>Now you may want to configure a few groups in <code>Directory</code> -&gt; <code>Groups</code> and assign people to them, as well as the application you just created, so that group members will be able to authenticate to your cluster. Initially you have just one user, whose username is the email address you registered to Okta with, but you can also create more if you wish, if you want to simulate a multi-user multi-group scenario.</p> <h3 id=configure-authorization-server>Configure authorization server<a class=headerlink href=#configure-authorization-server title="Permanent link">&para;</a></h3> <p>You need to ensure that group memberships are passed along in the JWT token when a user authenticates, and you must instruct the authorization server to do so.</p> <p>Go to <code>Security</code> -&gt; <code>API</code> and hit the pencil next to the <code>default</code> authorization server to modify it. Go to <code>Claims</code> and add a new claim: the name must be <code>groups</code>, included in <code>ID Token</code> type <code>Always</code>, and you may want to pass all the groups, with no filtering whatsoever. So the value type must be <code>Groups</code> and the filter <code>Matches regex</code> <code>.*</code>, and it must be included in <code>Any scope</code>.</p> <p>You can test the settings in the <code>Token Preview</code> tab.</p> <p>Further details are available in the <a href=https://developer.okta.com/docs/guides/customize-tokens-groups-claim/main/ >official Okta docs</a>.</p> <h2 id=configure-pinniped-during-management-cluster-deployment>Configure pinniped during management cluster deployment<a class=headerlink href=#configure-pinniped-during-management-cluster-deployment title="Permanent link">&para;</a></h2> <p>There are a few variables you need to set during management cluster installation, either via the GUI or the flat configuration file, as described in the section about <a href=../management-cluster/#prepare-management-cluster-configuration>TKG management cluster</a>.</p> <p>Such variables, as described also in the <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.1/tkg-deploy-mc-21/mgmt-deploy-config-ref.html#identity-management-oidc>VMware official docs</a>, are</p> <div class=highlight><pre><span></span><code><span class=nt>IDENTITY_MANAGEMENT_TYPE</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">oidc</span>
<span class=nt>OIDC_IDENTITY_PROVIDER_CLIENT_ID</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;OIDC-CLIENT-ID&gt;</span>
<span class=nt>OIDC_IDENTITY_PROVIDER_CLIENT_SECRET</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;OIDC-CLIENT-SECRET&gt;</span>
<span class=nt>OIDC_IDENTITY_PROVIDER_GROUPS_CLAIM</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">groups</span>
<span class=nt>OIDC_IDENTITY_PROVIDER_ISSUER_URL</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">https://&lt;OIDC_ENDPOINT&gt;</span>
<span class=nt>OIDC_IDENTITY_PROVIDER_NAME</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">&lt;IDP-NAME&gt;</span>
<span class=nt>OIDC_IDENTITY_PROVIDER_SCOPES</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">email,profile,groups</span>
<span class=nt>OIDC_IDENTITY_PROVIDER_USERNAME_CLAIM</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">email</span>
</code></pre></div> <p>They must be set in the flat configuration file and the deployment process will take care of the rest, generating TLS certificates too. For publicly trusted certificates (or at least within the enterprise, if a private CA is available) there will be a dedicated section.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Those variables need to be set <strong>only</strong> in the management cluster; in fact, all workload clusters will inherit the same configuration from their own management cluster.</p> </div> <h2 id=configure-pinniped-after-management-cluster-deployment>Configure pinniped after management cluster deployment<a class=headerlink href=#configure-pinniped-after-management-cluster-deployment title="Permanent link">&para;</a></h2> <p>OIDC authentication can be activated on existing management clusters, too. In fact, whether or not OIDC configs are passed to the management cluster during deployment, a <code>PackageInstall</code> resource for pinniped is created, but its reconciliation fails until a specific secret, containing the package's configuration values, is created in the <code>tkg-system</code> namespace. <code>kapp-controller</code> is on the lookout for such a secret and completes the package installation as soon as it is available.</p> <p>To get the secret manifest generated, you need to mock a flat configuration file and fake a TKG cluster creation, in order to get back the secret's YAML definition.</p> <p>Make a copy of your previous management cluster flat file and add the variables defined in the <a href=#configure-pinniped-during-management-cluster-deployment>previous paragraph</a>. Set a fake value for the <code>VSPHERE_CONTROL_PLANE_ENDPOINT</code> variable, to an unused IP, like</p> <div class=highlight><pre><span></span><code><span class=nt>VSPHERE_CONTROL_PLANE_ENDPOINT</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">1.1.1.1</span>
</code></pre></div> <p>otherwise the Tanzu CLI would fail during pre-flight checks, because the original endpoint is already taken by the existing cluster.</p> <p>Then set a few environment variables:</p> <div class=highlight><pre><span></span><code><span class=nb>export</span><span class=w> </span><span class=nv>IDENTITY_MANAGEMENT_TYPE</span><span class=o>=</span>oidc
<span class=nb>export</span><span class=w> </span><span class=nv>_TKG_CLUSTER_FORCE_ROLE</span><span class=o>=</span><span class=s2>&quot;management&quot;</span>
<span class=nb>export</span><span class=w> </span><span class=nv>FILTER_BY_ADDON_TYPE</span><span class=o>=</span><span class=s2>&quot;authentication/pinniped&quot;</span>
</code></pre></div> <p>Then generate the secret's YAML manifest:</p> <div class=highlight><pre><span></span><code>tanzu<span class=w> </span>cluster<span class=w> </span>create<span class=w> </span>&lt;CLUSTER-NAME&gt;<span class=w> </span>--dry-run<span class=w> </span>--file<span class=w> </span>/path/to/the/yaml/config/file<span class=w> </span>&gt;<span class=w> </span>pinniped-secret.yaml
</code></pre></div> <p>Make sure you pick the actual cluster name, as shown in</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>get<span class=w> </span>clusters.cluster.x-k8s.io<span class=w> </span>-n<span class=w> </span>tkg-system
</code></pre></div> <p>Do to take a look at the generated <code>pinniped-secret.yaml</code> file and change it if your cluster is behind a proxy. In fact, proxy configurations do not get passed along to the pinniped values, and so you have to set the values for:</p> <ul> <li><code>http_proxy</code></li> <li><code>https_proxy</code></li> <li><code>no_proxy</code></li> </ul> <p>The <code>no_proxy</code> variable is a comma-separated list of IP or domains patterns (<a href=https://about.gitlab.com/blog/2021/01/27/we-need-to-talk-no-proxy/#no_proxy-1>this</a> is worth a read). Remember to add to it also the CIDR range of your services network (i.e. <code>100.64.0.0/13</code>).</p> <p>Then you must apply the YAML manifest to the cluster</p> <div class=highlight><pre><span></span><code>kubectl<span class=w> </span>apply<span class=w> </span>-f<span class=w> </span>pinniped-secret.yaml
</code></pre></div> <p>You can monitor the status of the configuration looking at the resources in the <code>pinniped-supervisor</code> namespace. In the end, you should have something like</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>kubectl<span class=w> </span>-n<span class=w> </span>pinniped-supervisor<span class=w> </span>get<span class=w> </span>all

NAME<span class=w>                                                   </span>READY<span class=w>   </span>STATUS<span class=w>      </span>RESTARTS<span class=w>   </span>AGE
pod/pinniped-post-deploy-controller-64c59657c5-hsd5w<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span><span class=w>          </span>109m
pod/pinniped-post-deploy-job-scstf<span class=w>                     </span><span class=m>0</span>/1<span class=w>     </span>Completed<span class=w>   </span><span class=m>0</span><span class=w>          </span>59m
pod/pinniped-supervisor-77d67dc647-f7bpd<span class=w>               </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span><span class=w>          </span>59m
pod/pinniped-supervisor-77d67dc647-t8fqq<span class=w>               </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>     </span><span class=m>0</span><span class=w>          </span>59m

NAME<span class=w>                          </span>TYPE<span class=w>       </span>CLUSTER-IP<span class=w>       </span>EXTERNAL-IP<span class=w>   </span>PORT<span class=o>(</span>S<span class=o>)</span><span class=w>         </span>AGE
service/pinniped-supervisor<span class=w>   </span>NodePort<span class=w>   </span><span class=m>100</span>.69.192.203<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>443</span>:31234/TCP<span class=w>   </span>109m

NAME<span class=w>                                              </span>READY<span class=w>   </span>UP-TO-DATE<span class=w>   </span>AVAILABLE<span class=w>   </span>AGE
deployment.apps/pinniped-post-deploy-controller<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span><span class=m>1</span><span class=w>            </span><span class=m>1</span><span class=w>           </span>109m
deployment.apps/pinniped-supervisor<span class=w>               </span><span class=m>2</span>/2<span class=w>     </span><span class=m>2</span><span class=w>            </span><span class=m>2</span><span class=w>           </span>109m

NAME<span class=w>                                                         </span>DESIRED<span class=w>   </span>CURRENT<span class=w>   </span>READY<span class=w>   </span>AGE
replicaset.apps/pinniped-post-deploy-controller-64c59657c5<span class=w>   </span><span class=m>1</span><span class=w>         </span><span class=m>1</span><span class=w>         </span><span class=m>1</span><span class=w>       </span>109m
replicaset.apps/pinniped-supervisor-77d67dc647<span class=w>               </span><span class=m>2</span><span class=w>         </span><span class=m>2</span><span class=w>         </span><span class=m>2</span><span class=w>       </span>109m

NAME<span class=w>                                 </span>COMPLETIONS<span class=w>   </span>DURATION<span class=w>   </span>AGE
job.batch/pinniped-post-deploy-job<span class=w>   </span><span class=m>1</span>/1<span class=w>           </span>8s<span class=w>         </span>59m
</code></pre></div> <p>It is worth to check the <code>pinniped-concierge</code> namespace as well:</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>kubectl<span class=w> </span>-n<span class=w> </span>pinniped-concierge<span class=w> </span>get<span class=w> </span>all

NAME<span class=w>                                                     </span>READY<span class=w>   </span>STATUS<span class=w>    </span>RESTARTS<span class=w>   </span>AGE
pod/pinniped-concierge-5f85876ff6-fpq9t<span class=w>                  </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>111m
pod/pinniped-concierge-5f85876ff6-n497d<span class=w>                  </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>111m
pod/pinniped-concierge-kube-cert-agent-f6fbff54f-7jtfp<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span>Running<span class=w>   </span><span class=m>0</span><span class=w>          </span>110m

NAME<span class=w>                               </span>TYPE<span class=w>        </span>CLUSTER-IP<span class=w>      </span>EXTERNAL-IP<span class=w>   </span>PORT<span class=o>(</span>S<span class=o>)</span><span class=w>   </span>AGE
service/pinniped-concierge-api<span class=w>     </span>ClusterIP<span class=w>   </span><span class=m>100</span>.71.104.69<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>443</span>/TCP<span class=w>   </span>111m
service/pinniped-concierge-proxy<span class=w>   </span>ClusterIP<span class=w>   </span><span class=m>100</span>.71.213.71<span class=w>   </span>&lt;none&gt;<span class=w>        </span><span class=m>443</span>/TCP<span class=w>   </span>111m

NAME<span class=w>                                                 </span>READY<span class=w>   </span>UP-TO-DATE<span class=w>   </span>AVAILABLE<span class=w>   </span>AGE
deployment.apps/pinniped-concierge<span class=w>                   </span><span class=m>2</span>/2<span class=w>     </span><span class=m>2</span><span class=w>            </span><span class=m>2</span><span class=w>           </span>111m
deployment.apps/pinniped-concierge-kube-cert-agent<span class=w>   </span><span class=m>1</span>/1<span class=w>     </span><span class=m>1</span><span class=w>            </span><span class=m>1</span><span class=w>           </span>110m

NAME<span class=w>                                                           </span>DESIRED<span class=w>   </span>CURRENT<span class=w>   </span>READY<span class=w>   </span>AGE
replicaset.apps/pinniped-concierge-5f85876ff6<span class=w>                  </span><span class=m>2</span><span class=w>         </span><span class=m>2</span><span class=w>         </span><span class=m>2</span><span class=w>       </span>111m
replicaset.apps/pinniped-concierge-kube-cert-agent-f6fbff54f<span class=w>   </span><span class=m>1</span><span class=w>         </span><span class=m>1</span><span class=w>         </span><span class=m>1</span><span class=w>       </span>110m
</code></pre></div> <div class="admonition info"> <p class=admonition-title>Info</p> <p>Using Kube-VIP, the only way to expose pinniped is via a NodePort service, thus do remember to set the appropriate rules in your network firewalls to allow the traffic to port 31234/tcp.</p> </div> <h2 id=provide-own-tls-certificates>Provide own TLS certificates<a class=headerlink href=#provide-own-tls-certificates title="Permanent link">&para;</a></h2> <p><a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.1/tkg-deploy-mc-21/mgmt-iam-custom-pinniped-certificates.html>https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.1/tkg-deploy-mc-21/mgmt-iam-custom-pinniped-certificates.html</a></p> <h2 id=configure-okta-redirect-uri>Configure Okta redirect URI<a class=headerlink href=#configure-okta-redirect-uri title="Permanent link">&para;</a></h2> <p>Now that you have pinniped configured and running, you can go back to your Okta account and set the redirect URI for your application. Edit the <code>General Settings</code> section of your application and set the sign-in redirect URI to <code>https://&lt;YOUR-MGMT-CLUSTER-ENDPOINT&gt;:31234/callback</code>. Use the very same endpoint you set in your certificate, if you happened to change it.</p> <h2 id=get-the-kubeconfig-file>Get the kubeconfig file<a class=headerlink href=#get-the-kubeconfig-file title="Permanent link">&para;</a></h2> <p>Use the Tanzu CLI to retrieve the kubeconfig file to authenticate via OIDC:</p> <div class=highlight><pre><span></span><code>tanzu<span class=w> </span>mc<span class=w> </span>kubeconfig<span class=w> </span>get<span class=w> </span>--export-file<span class=w> </span>/tmp/tkgm.oidc.kubeconfig
</code></pre></div> <p>Open the file and look at the <code>users</code> object; the <code>tanzu pinniped-auth login</code> command is used to authenticate the user, with a few configuration options:</p> <ul> <li>make sure the <code>--issuer</code> flag points to the same endpoint as the <a href=#configure-okta-redirect-uri>Okta redirect URI</a> (without the trailing <code>/callback</code>);</li> <li>add the item <code>--skip-browser</code> to the end of the <code>args</code> list, to prevent the Tanzu CLI from trying to run a browser to let the user authenticate (on SSH-based jumphosts you do not have nor you do want to have a GUI).</li> </ul> <p>Run a <code>kubectl get</code> command with the new kubeconfig file to get prompted for authentication</p> <div class=highlight><pre><span></span><code>❯<span class=w> </span>kubectl<span class=w> </span>get<span class=w> </span>pods<span class=w> </span>--kubeconfig<span class=w> </span>~/t1xl/t1xl.oidc.kubeconfig
Log<span class=w> </span><span class=k>in</span><span class=w> </span>by<span class=w> </span>visiting<span class=w> </span>this<span class=w> </span>link:

<span class=w>    </span>https://my.cluster.endpoint:31234/oauth2/authorize?access_type<span class=o>=</span>offline<span class=p>&amp;</span><span class=nv>client_id</span><span class=o>=</span>pinniped-cli<span class=p>&amp;</span><span class=nv>code_challenge</span><span class=o>=</span>lGjmpPEfyN0544UEOr2QYWawsWBzKOorlQG-Ws73FHs<span class=p>&amp;</span><span class=nv>code_challenge_method</span><span class=o>=</span>S256<span class=p>&amp;</span><span class=nv>nonce</span><span class=o>=</span>48cd4fc34b4e789ee8e6e590ae54aab0<span class=p>&amp;</span><span class=nv>redirect_uri</span><span class=o>=</span>http%3A%2F%2F127.0.0.1%3A45359%2Fcallback<span class=p>&amp;</span><span class=nv>response_mode</span><span class=o>=</span>form_post<span class=p>&amp;</span><span class=nv>response_type</span><span class=o>=</span>code<span class=p>&amp;</span><span class=nv>scope</span><span class=o>=</span>offline_access+openid+pinniped%3Arequest-audience<span class=p>&amp;</span><span class=nv>state</span><span class=o>=</span>93b02cc91ad38b8e905844abcf0c6144

<span class=w>    </span>Optionally,<span class=w> </span>paste<span class=w> </span>your<span class=w> </span>authorization<span class=w> </span>code:
</code></pre></div> <p>Paste the URL in your browser, authenticate to Okta and you get a code back that you have to paste into the console: you are now authenticated. You can see your token details (including the groups that have been passed along) at <code>~/.config/tanzu/pinniped/sessions.yaml</code>.</p> <p>Your request is going to fail unless you have already <a href=#configure-rbac>configured RBAC</a> on your cluster.</p> <h2 id=configure-rbac>Configure RBAC<a class=headerlink href=#configure-rbac title="Permanent link">&para;</a></h2> <p>If you have correctly configured <a href=#create-users-and-groups>users and groups</a> and the <a href=#configure-authorization-server>authorization server</a>, you should now find a list of groups in the <code>~/.config/tanzu/pinniped/sessions.yaml</code> file for your TKG ID token.</p> <p>The authorization part still lies on the Kubernetes part, leveraging <code>Role</code>s and <code>ClusterRole</code>s for defining permissions, and <code>RoleBinding</code>s and <code>ClusterRoleBinding</code>s for granting them to either users or groups.</p> <p>TKG comes with a few pre-defined <code>ClusterRole</code>s</p> <ul> <li>cluster-admin: Full access to the cluster. When used in a RoleBinding, this role gives full access to any resource in the namespace specified in the binding.</li> <li>admin: Admin access to most resources in a namespace. Can create and modify roles and role bindings within the namespace.</li> <li>edit: Read-write access to most objects in a namespace, such as deployments, services, and pods. Cannot view, create, or modify roles and role bindings.</li> <li>view: Read-only access to most objects in a namespace. Cannot view, create, or modify roles and role bindings</li> </ul> <p>More info at <a href=https://docs.vmware.com/en/VMware-Tanzu-Kubernetes-Grid/2.1/tkg-deploy-mc-21/mgmt-iam-configure-rbac.html>VMware docs</a>.</p> <p>As an example, a simple <code>ClusterRoleBinding</code> that grants a group <code>view</code> permissions on all namespaces can be defined as:</p> <div class=highlight><pre><span></span><code><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
<span class=nt>metadata</span><span class=p>:</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dev-view</span>
<span class=nt>roleRef</span><span class=p>:</span>
<span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">view</span>
<span class=nt>subjects</span><span class=p>:</span>
<span class="p p-Indicator">-</span><span class=w> </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">Group</span>
<span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class="l l-Scalar l-Scalar-Plain">dev</span>
</code></pre></div> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime">2023-03-03 10:59:13</span> </small> </div> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2023 Matteo Magni </div> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tabs", "navigation.instant", "navigation.tabs.sticky", "content.code.annotate", "content.code.copy"], "search": "../../assets/javascripts/workers/search.74e28a9f.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.220ee61c.min.js></script> </body> </html>